<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面部动画用户研究</title>
    <!-- <style> 部分和之前的版本完全一样 -->
</head>
<body>
    <div class="container">
        <h1>请您评判哪个视频的面部动画效果更好</h1>
        <div class="instructions">
            <!-- 指导语和之前一样 -->
        </div>

        <!-- ==================== 第 1 题 ==================== -->
        <!-- 使用 data-* 属性来定义这一题的元数据 -->
        <div class="question-item" id="item-1"
             data-model-names='{"modelX": "Ours", "modelY": "DiffPoseTalk"}'
             data-video-srcs='{"modelX": "ours_video_1.mp4", "modelY": "diffposetalk_video_1.mp4"}'>
            
            <h2>第 1 题</h2>
            <div class="video-container">
                <!-- 视频播放器将由JS动态创建 -->
            </div>
            <div class="questions-container">
                <!-- 问卷表格将由JS动态创建 -->
            </div>
            <div class="submit-container">
                <p class="error-message">为继续，请您回答所有问题！</p>
                <button class="submit-button" style="display: none;">提交第 1 题</button>
            </div>
        </div>

        <!-- ==================== 第 2 题 ==================== -->
        <div class="question-item" id="item-2"
             data-model-names='{"modelX": "Ours", "modelY": "FaceFormer"}'
             data-video-srcs='{"modelX": "ours_video_2.mp4", "modelY": "faceformer_video_2.mp4"}'>
            <!-- 内部结构为空，将由JS动态填充 -->
        </div>
        
        <!-- ... 您可以在这里添加第 3, 4, 5 题的 div ... -->
    </div>

    <script>
        const SCRIPT_URL = '在这里粘贴你自己的Google Apps Script Web应用URL';

        document.addEventListener('DOMContentLoaded', () => {
            const questionItems = document.querySelectorAll('.question-item');
            
            questionItems.forEach((item, index) => {
                const questionId = index + 1;
                const modelNames = JSON.parse(item.dataset.modelNames);
                const videoSrcs = JSON.parse(item.dataset.videoSrcs);

                // 随机决定 ModelX 和 ModelY 哪个是 A (左侧)
                const isSwapped = Math.random() < 0.5;

                const modelA = isSwapped ? modelNames.modelY : modelNames.modelX;
                const modelB = isSwapped ? modelNames.modelX : modelNames.modelY;
                const videoASrc = isSwapped ? videoSrcs.modelY : videoSrcs.modelX;
                const videoBSrc = isSwapped ? videoSrcs.modelX : videoSrcs.modelY;
                
                // 存储这个随机结果，以便提交时使用
                item.dataset.modelA = modelA;
                item.dataset.modelB = modelB;

                // 动态生成HTML内容
                item.innerHTML = `
                    <h2>第 ${questionId} 题</h2>
                    <div class="video-container">
                         <div class="video-wrapper"><h2>视频 A (左)</h2><video controls src="${videoASrc}"></video></div>
                         <div class="video-wrapper"><h2>视频 B (右)</h2><video controls src="${videoBSrc}"></video></div>
                    </div>
                    <div class="questions-container">
                        <form id="study-form-${questionId}">
                            <table class="matrix-table">
                               <thead>...</thead> <!-- 表头和之前一样 -->
                               <tbody>
                                    <tr>
                                        <td><strong>口型同步性</strong></td>
                                        <td><input type="radio" name="lip_sync" value="A"></td>
                                        ...
                                    </tr>
                                    <tr>
                                        <td><strong>面部表情与真实感</strong></td>
                                        <td><input type="radio" name="realism" value="A"></td>
                                        ...
                                    </tr>
                               </tbody>
                            </table>
                        </form>
                    </div>
                    <div class="submit-container">
                        <p class="error-message" id="error-message-${questionId}">为继续，请您回答所有问题！</p>
                        <button class="submit-button" data-question-id="${questionId}">提交第 ${questionId} 题</button>
                    </div>
                `;
            });

            // 重新绑定提交按钮事件，因为它们是动态生成的
            bindSubmitEvents();
        });

        function bindSubmitEvents() {
            const submitButtons = document.querySelectorAll('.submit-button');
            submitButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    
                    const questionId = event.target.dataset.questionId;
                    const form = document.getElementById(`study-form-${questionId}`);
                    const questionItem = document.getElementById(`item-${questionId}`);
                    const errorMessage = document.getElementById(`error-message-${questionId}`);

                    const lip_sync_choice = form.elements['lip_sync'].value; // 'A', 'B', '效果相当'
                    const realism_choice = form.elements['realism'].value;

                    if (lip_sync_choice && realism_choice) {
                        errorMessage.style.display = 'none';
                        event.target.disabled = true;
                        event.target.textContent = '提交中...';

                        const modelA = questionItem.dataset.modelA;
                        const modelB = questionItem.dataset.modelB;
                        
                        function translateChoice(choice) {
                            if (choice === 'A') return modelA;
                            if (choice === 'B') return modelB;
                            return '效果相当';
                        }

                        const results = {
                            question_id: `第 ${questionId} 题`,
                            lip_sync: translateChoice(lip_sync_choice),
                            realism: translateChoice(realism_choice),
                            condition_A_was: modelA, // (可选) 额外记录当时的分配情况
                            condition_B_was: modelB
                        };
                        
                        // ... (后面的 fetch 提交代码和之前完全一样) ...
                    } else {
                        errorMessage.style.display = 'block';
                    }
                });
            });
        }
    </script>
</body>
</html>
